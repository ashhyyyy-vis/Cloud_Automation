name: Deploy (Mock AWS)

on:
  workflow_run:
    workflows: ["Stack-Agnostic CI"]
    types: [completed]

jobs:
  ####################################################################
  #                            PREPARE                               #
  ####################################################################
  prepare:
    runs-on: ubuntu-latest
    outputs:
      apps-json: ${{ steps.read.outputs.apps }}
      app-ids: ${{ steps.ids.outputs.ids }}
      apps-b64: ${{ steps.ids.outputs.apps_b64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Read deployment-config.yaml
        id: read
        shell: bash
        run: |
          if [ ! -f deployment-config.yaml ]; then
            echo "ERROR: deployment-config.yaml not found"
            exit 1
          fi

          # Extract ONLY backend section and convert to compact JSON
          APPS=$(yq -o=json '.backend' deployment-config.yaml | jq -c '.')
          echo "apps=$APPS" >> $GITHUB_OUTPUT

      - name: Extract backend app IDs
        id: ids
        shell: bash
        run: |
          RAW='${{ steps.read.outputs.apps }}'

          # Base64 encode block
          RAW_B64=$(printf "%s" "$RAW" | base64 -w0)
          echo "apps_b64=$RAW_B64" >> $GITHUB_OUTPUT

          # Extract YAML keys → JSON array
          IDS=$(echo "$RAW" | yq -o=json 'keys')
          echo "ids=$IDS" >> $GITHUB_OUTPUT

  ####################################################################
  #                           DEPLOY                                 #
  ####################################################################
  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare.outputs.app-ids) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Parse backend app config
        id: parse
        shell: bash
        run: |
          APP_KEY="${{ matrix.app-id }}"
          APP_KEY=$(echo "$APP_KEY" | sed 's/"//g')

          # Decode backend section
          APPS_JSON=$(echo "${{ needs.prepare.outputs.apps-b64 }}" | base64 -d)

          # Extract selected backend module
          APP_JSON=$(printf "%s" "$APPS_JSON" | yq -o=json ".\"$APP_KEY\"")

          echo "$APP_JSON" | yq '.'

          echo "image_repo=$(echo "$APP_JSON" | yq -r '.image_repo')" >> $GITHUB_OUTPUT
          echo "launch_template_id=$(echo "$APP_JSON" | yq -r '.launch_template_id')" >> $GITHUB_OUTPUT
          echo "asg_name=$(echo "$APP_JSON" | yq -r '.asg_name')" >> $GITHUB_OUTPUT
          echo "region=$(echo "$APP_JSON" | yq -r '.region')" >> $GITHUB_OUTPUT
          echo "port=$(echo "$APP_JSON" | yq -r '.port')" >> $GITHUB_OUTPUT
          echo "health_path=$(echo "$APP_JSON" | yq -r '.health_path')" >> $GITHUB_OUTPUT
          echo "instance_warmup=$(echo "$APP_JSON" | yq -r '.instance_warmup')" >> $GITHUB_OUTPUT
          echo "min_healthy_percent=$(echo "$APP_JSON" | yq -r '.min_healthy_percent')" >> $GITHUB_OUTPUT
          echo "user_data_template=$(echo "$APP_JSON" | yq -r '.user_data_template')" >> $GITHUB_OUTPUT
          echo "ssm_param_name=$(echo "$APP_JSON" | yq -r '.ssm_param_name')" >> $GITHUB_OUTPUT

      - name: Mock AWS Credentials
        run: |
          echo "=== MOCK CREDS ==="
          echo "Region: ${{ steps.parse.outputs.region }}"

      - name: Export deployment vars
        id: vars
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image_repo=${{ steps.parse.outputs.image_repo }}" >> $GITHUB_OUTPUT
          echo "lt_id=${{ steps.parse.outputs.launch_template_id }}" >> $GITHUB_OUTPUT
          echo "asg_name=${{ steps.parse.outputs.asg_name }}" >> $GITHUB_OUTPUT
          echo "ud_template=${{ steps.parse.outputs.user_data_template }}" >> $GITHUB_OUTPUT
          echo "ssm_param=${{ steps.parse.outputs.ssm_param_name }}" >> $GITHUB_OUTPUT
          echo "warmup=${{ steps.parse.outputs.instance_warmup }}" >> $GITHUB_OUTPUT
          echo "minheal=${{ steps.parse.outputs.min_healthy_percent }}" >> $GITHUB_OUTPUT

      - name: Mock SSM Update
        if: ${{ steps.vars.outputs.ud_template == 'ssm' }}
        run: |
          echo "MOCK SSM update → ${{ steps.vars.outputs.ssm_param }}"

      - name: Mock Launch Template Update
        if: ${{ steps.vars.outputs.ud_template != 'ssm' }}
        id: newlt
        run: |
          echo "Mock LT update"
          echo "new_version=42" >> $GITHUB_OUTPUT

      - name: Mock ASG Update
        run: |
          echo "Mock ASG update"

      - name: Mock Instance Refresh
        id: refresh
        run: |
          echo "refresh_id=mock-123" >> $GITHUB_OUTPUT

      - name: Mock Refresh Status
        run: |
          echo "Mock refresh: Successful"