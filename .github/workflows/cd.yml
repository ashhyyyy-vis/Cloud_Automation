name: Deploy (Platform - SSM)

on:
  workflow_run:
    workflows: ["Backend CI"]
    types: [completed]

permissions:
  contents: read
  packages: read
  statuses: write
  id-token: write

env:
  SSM_PREFIX: /hosting-template/compute/backend
  DEFAULT_AWS_REGION: ap-south-1

jobs:
  ####################################################################
  #                            PREPARE                               #
  ####################################################################
  prepare:
    runs-on: ubuntu-latest
    outputs:
      app-ids: ${{ steps.ids.outputs.ids }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS for SSM read
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ env.DEFAULT_AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: prepare-ssm

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: List SSM modules
        id: ids
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="${{ env.SSM_PREFIX }}"

          NAMES=$(aws ssm get-parameters-by-path \
            --path "$PREFIX" \
            --recursive \
            --query 'Parameters[].Name' \
            --output json)

          if [ "$(echo "$NAMES" | jq 'length')" -eq 0 ]; then
            echo "No modules under $PREFIX"
            echo "ids=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          IDS=$(
            echo "$NAMES" | jq -r '.[]' \
            | sed "s|^${PREFIX}/||" \
            | awk -F'/' '{print $1}' \
            | sort -u \
            | jq -R -s -c 'split("\n")[:-1]'
          )

          echo "ids=$IDS" >> $GITHUB_OUTPUT

  ####################################################################
  #                            DEPLOY                                #
  ####################################################################
  deploy:
    needs: prepare
    continue-on-error: true
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare.outputs.app-ids) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS for deployment
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ env.DEFAULT_AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: deploy-ssm

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Read module config from SSM
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="${{ env.SSM_PREFIX }}"
          ID="${{ matrix.app-id }}"

          KEYS=(image_repo asg_name region port health_path instance_warmup min_healthy_percent user_data_template ssm_param_name)

          for k in "${KEYS[@]}"; do
            P="${PREFIX}/${k}"
            V=$(aws ssm get-parameter --name "$P" --with-decryption --query 'Parameter.Value' --output text 2>/dev/null || echo "")
            echo "${k}=$V" >> $GITHUB_OUTPUT
          done

      - name: Debug module config
        run: |
          echo "Module: ${{ matrix.app-id }}"
          echo "image_repo: ${{ steps.parse.outputs.image_repo }}"
          echo "asg_name: ${{ steps.parse.outputs.asg_name }}"
          echo "region: ${{ steps.parse.outputs.region }}"
          echo "ssm_param_name: ${{ steps.parse.outputs.ssm_param_name }}"

      - name: Update SSM Param with new image
        id: ssm_update
        shell: bash
        run: |
          IMAGE="${{ steps.parse.outputs.image_repo }}:${{ github.sha }}"

          TARGET="${{ steps.parse.outputs.ssm_param_name }}"
          if [ -z "$TARGET" ]; then
            TARGET="${{ env.SSM_PREFIX }}/${{ matrix.app-id }}/image_uri"
          fi

          echo "Updating $TARGET -> $IMAGE"
          aws ssm put-parameter --name "$TARGET" --value "$IMAGE" --type String --overwrite
          echo "updated_param=$TARGET" >> $GITHUB_OUTPUT

      - name: Safe ASG refresh
        id: refresh
        shell: bash
        run: |
          ASG="${{ steps.parse.outputs.asg_name }}"
          if [ -z "$ASG" ]; then
            echo "No ASG for module, skipping"
            echo "refresh_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for any in-progress refreshes
          CURRENT_REFRESH=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name "$ASG" \
            --query 'InstanceRefreshes[?Status==`InProgress`]' \
            --output json)

          # If there's an in-progress refresh, cancel it
          if [ "$(echo "$CURRENT_REFRESH" | jq 'length')" -gt 0 ]; then
            REFRESH_ID=$(echo "$CURRENT_REFRESH" | jq -r '.[0].InstanceRefreshId')
            echo "Cancelling in-progress refresh: $REFRESH_ID"
            aws autoscaling cancel-instance-refresh \
              --auto-scaling-group-name "$ASG" \
              --instance-refresh-id "$REFRESH_ID" || true
          
            # Wait for the cancellation to complete
            echo "Waiting for cancellation to complete..."
            aws autoscaling wait instance-refresh-cancelled \
              --auto-scaling-group-name "$ASG" \
              --instance-refresh-ids "$REFRESH_ID" || true
          fi

          # Start a new refresh
          echo "Starting new instance refresh..."
          RID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG" \
            --strategy Rolling \
            --query 'InstanceRefreshId' --output text)

          echo "Started new refresh: $RID"
          echo "refresh_id=$RID" >> $GITHUB_OUTPUT

      - name: Get previous stable version
        id: prev
        if: steps.refresh.outputs.refresh_id != ''
        shell: bash
        run: |
          PREFIX="${{ env.SSM_PREFIX }}"
          ID="${{ matrix.app-id }}"

          STABLE="${PREFIX}/${ID}/stable_image_uri"

          PREV=$(aws ssm get-parameter \
            --name "$STABLE" \
            --query "Parameter.Value" \
            --output text 2>/dev/null || echo "")

          echo "PREV_IMAGE=$PREV" >> $GITHUB_ENV

          CURRENT="${{ steps.parse.outputs.image_repo }}:${{ github.sha }}"
          echo "CURRENT_IMAGE=$CURRENT" >> $GITHUB_ENV

      - name: Wait for refresh
        id: wait
        if: steps.refresh.outputs.refresh_id != ''
        timeout-minutes: 60
        continue-on-error: true
        shell: bash
        run: |
          ASG="${{ steps.parse.outputs.asg_name }}"
          REF="${{ steps.refresh.outputs.refresh_id }}"

          for i in {1..120}; do
            S=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "$ASG" \
              --instance-refresh-ids "$REF" \
              --query 'InstanceRefreshes[0].Status' \
              --output text)

            echo "Status: $S"

            if [ "$S" = "Successful" ]; then
              # now mark this version stable
              STABLE="${{ env.SSM_PREFIX }}/${{ matrix.app-id }}/stable_image_uri"
              aws ssm put-parameter --name "$STABLE" --value "${{ env.CURRENT_IMAGE }}" --type String --overwrite
              exit 0
            fi

            if [[ "$S" =~ Failed|Cancelled|RollbackInProgress|RollbackFailed ]]; then
              exit 1
            fi

            sleep 30
          done

          exit 1

      - name: Rollback if needed
        if: steps.wait.outcome == 'failure' && env.PREV_IMAGE != ''
        shell: bash
        run: |
          PREFIX="${{ env.SSM_PREFIX }}"
          ID="${{ matrix.app-id }}"

          TARGET="${PREFIX}/${ID}/image_uri"

          echo "Rollback to ${PREV_IMAGE}"
          aws ssm put-parameter --name "$TARGET" --value "${PREV_IMAGE}" --type String --overwrite

          ASG="${{ steps.parse.outputs.asg_name }}"
          [ -z "$ASG" ] || aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG" \
            --strategy Rolling

          exit 1

      - name: Smoke test
        if: steps.wait.outcome == 'success'
        run: |
          echo "Smoke test placeholder â€” OK"