name: Deploy All Frontends

on:
  workflow_run:
    workflows: ["Stack-Agnostic CI"]
    types: [completed]

jobs:
  prepare-frontend-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - id: read
        name: Read frontend modules from config.yaml
        shell: bash
        run: |
          echo "Reading frontend modules from YAML..."

          # Extract keys under: apps â†’ frontend
          FRONTEND=$(yq -o=json '.apps.frontend | keys' config.yaml)

          echo "Frontend apps: $FRONTEND"
          echo "matrix=$FRONTEND" >> $GITHUB_OUTPUT

  deploy-frontend:
    needs: prepare-frontend-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare-frontend-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Deploy Frontend
        uses: ./.github/actions/deploy-to-s3
        with:
          app-type: frontend
          app-id: ${{ matrix.app-id }}
          config-path: ./config.yaml
          aws-config-path: ./frontend-config.yaml
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
