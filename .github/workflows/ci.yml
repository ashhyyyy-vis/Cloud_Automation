name: Stack-Agnostic CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read-config.outputs.matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: read-config
        name: Read config.json and extract app IDs
        shell: bash
        run: |
          echo "üîç Reading config.json..."
          cat config.json || echo "‚ùå config.json not found!"

          # Extract keys under .apps (["source_1","source_2",...])
          MATRIX=$(jq -c '.apps | keys' config.json)

          echo "üîç Extracted matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build-and-test:
    needs: prepare-matrix
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment for ${{ matrix.app-id }}
        id: setup
        uses: ./.github/actions/setup
        with:
          app-id: ${{ matrix.app-id }}
          config-path: ./config.json

      ######################################################################
      #                         DYNAMIC LINTING                            #
      ######################################################################

      - name: Prepare lint paths
        id: lintprep
        shell: bash
        run: |
          echo "Lint enabled: ${{ steps.setup.outputs.lint }}"
          echo "Lint path raw JSON: ${{ steps.setup.outputs.lint_path }}"

          if [ "${{ steps.setup.outputs.lint }}" != "true" ]; then
            echo "LINT_TARGETS=" >> $GITHUB_ENV
            exit 0
          fi

          LINT_PATH_JSON='${{ steps.setup.outputs.lint_path }}'

          # Case 1: null ‚Üí lint entire directory
          if [ "$LINT_PATH_JSON" = "null" ]; then
            echo "LINT_TARGETS=${{ steps.setup.outputs.directory }}" >> $GITHUB_ENV
            exit 0
          fi

          # Case 2: string ‚Üí convert to list
          # Case 3: object ‚Üí convert values to list
          TARGETS=$(echo "$LINT_PATH_JSON" | jq -r '
            if type=="string" then
              [.]          # convert single string to array
            else
              [.[]]        # get all values from object
            end | join(" ")
          ')

          # Targets are relative; convert to full paths
          FULL=""
          for t in $TARGETS; do
            FULL="$FULL ${{ steps.setup.outputs.directory }}/$t"
          done

          echo "LINT_TARGETS=$FULL" >> $GITHUB_ENV
          echo "Computed LINT_TARGETS: $FULL"

      - name: Run Super-Linter
        if: env.LINT_TARGETS != ''
        uses: super-linter/super-linter@v6
        env:
          DEFAULT_BRANCH: "main"
          # We lint ONLY the computed paths
          FILTER_REGEX_INCLUDE: ${{ env.LINT_TARGETS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      ######################################################################
      #                         DOCKER BUILD                               #
      ######################################################################

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build & Push Image
        if: github.event_name != 'pull_request'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          APP_DIR: ${{ steps.setup.outputs.directory }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "üìù DEBUG: APP_DIR='$APP_DIR'"
          
          IMAGE_APP=$(basename "$APP_DIR")
          echo "üìù DEBUG: IMAGE_APP='$IMAGE_APP'"

          if [ -z "$APP_DIR" ]; then
            echo "‚ùå ERROR: APP_DIR is empty. Composite action did not output directory."
            exit 1
          fi

          # Build image
          docker build -t $DOCKERHUB_USERNAME/$IMAGE_APP:latest "$APP_DIR"

          # Push latest
          docker push $DOCKERHUB_USERNAME/$IMAGE_APP:latest

          # Tag & push SHA version
          docker tag $DOCKERHUB_USERNAME/$IMAGE_APP:latest \
                      $DOCKERHUB_USERNAME/$IMAGE_APP:$COMMIT_SHA
          docker push $DOCKERHUB_USERNAME/$IMAGE_APP:$COMMIT_SHA
