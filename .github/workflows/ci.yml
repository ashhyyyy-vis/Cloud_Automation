name: Backend CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: read
  statuses: write

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read.outputs.matrix }}
      app_types: ${{ steps.read.outputs.types }}

    steps:
      - uses: actions/checkout@v4

      - id: read
        name: Read config.json and extract app IDs
        shell: bash
        run: |
          echo "ðŸ” Reading config.json..."

          if [ ! -f config.json ]; then
            echo "âŒ config.json missing!"
            exit 1
          fi

          # Read only backend keys
          BACKEND=$(jq -c '.apps.backend | keys // []' config.json)

          echo "Backend modules: $BACKEND"

          # Output backend modules as matrix
          echo "matrix=$BACKEND" >> $GITHUB_OUTPUT
          echo "types=$(jq -c -n --argjson b "$BACKEND" '$b | map({"id": ., "type": "backend"})')" >> $GITHUB_OUTPUT

  build-and-test:
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment for ${{ matrix.app-id }}
        id: setup
        uses: ./.github/actions/setup
        with:
          app-id: ${{ matrix.app-id }}
          config-path: ./config.json

      - name: Prepare lint paths
        id: lintprep
        shell: bash
        run: |
          echo "Lint enabled: ${{ steps.setup.outputs.lint }}"
          echo "Lint path raw JSON: ${{ steps.setup.outputs.lint_path }}"

          if [ "${{ steps.setup.outputs.lint }}" != "true" ]; then
            echo "LINT_TARGETS=" >> $GITHUB_ENV
            exit 0
          fi

          LINT_PATH_JSON='${{ steps.setup.outputs.lint_path }}'

          if [ "$LINT_PATH_JSON" = "null" ]; then
            DIR="${{ steps.setup.outputs.directory }}"
            echo "LINT_TARGETS=(${DIR}/.*)" >> $GITHUB_ENV
            exit 0
          fi

          TARGETS=$(echo "$LINT_PATH_JSON" | jq -r '
            if type=="string" then
              [.]
            else
              [.[]]
            end | join(" ")
          ')

          REGEX_PARTS=()
          APP_DIR="${{ steps.setup.outputs.directory }}"

          for t in $TARGETS; do
            t_trimmed=$(echo "$t" | xargs)
            [ -z "$t_trimmed" ] && continue
            
            if [[ "$t_trimmed" == /* ]]; then
               CLEAN_PATH="${t_trimmed#/}"
            else
               CLEAN_PATH="${APP_DIR}/${t_trimmed}"
            fi

            if [[ "$CLEAN_PATH" == *.* ]]; then
               REGEX_PARTS+=("${CLEAN_PATH}")
            else
               REGEX_PARTS+=("${CLEAN_PATH}/.*")
            fi
          done

          IFS="|"
          REGEX_STRING="(${REGEX_PARTS[*]})"
          IFS=" "

          echo "LINT_TARGETS=$REGEX_STRING" >> $GITHUB_ENV
          echo "Computed LINT_TARGETS (Regex): $REGEX_STRING"

      - name: Run Super-Linter
        if: env.LINT_TARGETS != ''
        uses: super-linter/super-linter@v6
        env:
          DEFAULT_BRANCH: "main"
          FILTER_REGEX_INCLUDE: ${{ env.LINT_TARGETS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISABLE_ERRORS: true

      - name: Configure AWS OIDC Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-south-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: ci-session

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        env:
          ECR: ${{ secrets.ECR_REPO }}
          APP_DIR: ${{ steps.setup.outputs.directory }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          docker build -t "$ECR:latest" "$APP_DIR"
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            docker push "$ECR:latest"
          fi