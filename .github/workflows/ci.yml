name: Stack-Agnostic CI
#ðŸ³ï¸â€âš§ï¸

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: read
  statuses: write
  
jobs:
  ######################################################################
  #                       PREPARE MATRIX                              #
  ######################################################################
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read.outputs.matrix }}
      app_types: ${{ steps.read.outputs.types }}

    steps:
      - uses: actions/checkout@v4

      - id: read
        name: Read config.json and extract app IDs
        shell: bash
        run: |
          echo "ðŸ” Reading config.json..."

          if [ ! -f config.json ]; then
            echo "âŒ config.json missing!"
            exit 1
          fi

          # Read keys for backend & frontend
          BACKEND=$(jq -c '.apps.backend | keys // []' config.json)
          FRONTEND=$(jq -c '.apps.frontend | keys // []' config.json)

          echo "Backend modules:  $BACKEND"
          echo "Frontend modules: $FRONTEND"

          # Combine into single array
          MATRIX=$(jq -c -n \
            --argjson b "$BACKEND" \
            --argjson f "$FRONTEND" \
            '$b + $f | unique'
          )

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # Also keep a parallel array showing type (backend/frontend)
          TYPES=$(jq -c -n \
            --argjson b "$BACKEND" \
            --argjson f "$FRONTEND" \
            '
              ($b | map({"id": ., "type": "backend"})) +
              ($f | map({"id": ., "type": "frontend"}))
            '
          )

          echo "types=$TYPES" >> $GITHUB_OUTPUT


  ######################################################################
  #                      BUILD + TEST JOBS                            #
  ######################################################################
  build-and-test:
    needs: prepare-matrix
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app-id: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      ##################################################################
      #     FETCH TYPE (backend/frontend) for CURRENT MATRIX ITEM      #
      ##################################################################
      - id: get-type
        name: Identify app type
        shell: bash
        run: |
          TYPES='${{ needs.prepare-matrix.outputs.app_types }}'
          APP='${{ matrix.app-id }}'

          TYPE=$(echo "$TYPES" | jq -r --arg id "$APP" '.[] | select(.id == $id) | .type')

          if [ -z "$TYPE" ]; then
            echo "âŒ Could not determine type for $APP"
            exit 1
          fi

          echo "type=$TYPE" >> $GITHUB_OUTPUT

      ##################################################################
      #                RUN SETUP (NODE/PYTHON/JAVA/etc)               #
      ##################################################################
      - name: Setup build environment for ${{ matrix.app-id }}
        id: setup
        uses: ./.github/actions/setup
        with:
          app-id: ${{ matrix.app-id }}
          config-path: ./config.json

      ##################################################################
      #                         LINT                                    #
      ##################################################################
      - name: Prepare lint paths
        id: lintprep
        shell: bash
        run: |
          echo "Lint enabled: ${{ steps.setup.outputs.lint }}"
          echo "Lint path raw JSON: ${{ steps.setup.outputs.lint_path }}"

          if [ "${{ steps.setup.outputs.lint }}" != "true" ]; then
            echo "LINT_TARGETS=" >> $GITHUB_ENV
            exit 0
          fi

          LINT_PATH_JSON='${{ steps.setup.outputs.lint_path }}'

          if [ "$LINT_PATH_JSON" = "null" ]; then
            echo "LINT_TARGETS=${{ steps.setup.outputs.directory }}" >> $GITHUB_ENV
            exit 0
          fi

          TARGETS=$(echo "$LINT_PATH_JSON" | jq -r '
            if type=="string" then [.] else [.[]] end | join(" ")
          ')

          FULL=()
          for t in $TARGETS; do
            t_trim=$(echo "$t" | xargs)
            [ -z "$t_trim" ] && continue
            FULL+=("${{ steps.setup.outputs.directory }}/$t_trim")
          done

          echo "LINT_TARGETS=${FULL[*]}" >> $GITHUB_ENV
          echo "Computed LINT_TARGETS: ${FULL[*]}"

      - name: Run Super-Linter
        if: env.LINT_TARGETS != ''
        uses: super-linter/super-linter@v6
        env:
          DEFAULT_BRANCH: "main"
          FILTER_REGEX_INCLUDE: ${{ env.LINT_TARGETS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      ##################################################################
      #                    BACKEND ONLY: DOCKER BUILD                   #
      ##################################################################
      - name: Docker Build Backend
        if: ${{ steps.get-type.outputs.type == 'backend' && github.event_name != 'pull_request' }}
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          APP_DIR: ${{ steps.setup.outputs.directory }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          IMAGE_APP=$(basename "$APP_DIR")

          docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" \
                       --password-stdin <<< "${{ secrets.DOCKERHUB_TOKEN }}"

          docker build -t $DOCKERHUB_USERNAME/$IMAGE_APP:latest "$APP_DIR"

          docker push $DOCKERHUB_USERNAME/$IMAGE_APP:latest

          docker tag $DOCKERHUB_USERNAME/$IMAGE_APP:latest \
                      $DOCKERHUB_USERNAME/$IMAGE_APP:$COMMIT_SHA

          docker push $DOCKERHUB_USERNAME/$IMAGE_APP:$COMMIT_SHA
