name: "Deploy Module to AWS S3"
description: "Deploys a frontend module using config.json + SSM parameters"

inputs:
  app-type:
    required: true
  app-id:
    required: true

  config-path:
    required: true
    default: ./config.json

  aws-access-key-id:
    required: true
  aws-secret-access-key:
    required: true

runs:
  using: composite
  steps:

    ##################################################################
    #                 INSTALL jq (JSON parser)                       #
    ##################################################################
    - name: Install jq
      shell: bash
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq

    ##################################################################
    #                READ MODULE CONFIG (from JSON)                  #
    ##################################################################
    - name: Read module config
      id: cfg
      shell: bash
      run: |
        CFG="${{ inputs.config-path }}"
        APP_ID="${{ inputs.app-id }}"
        APP_TYPE="${{ inputs.app-type }}"

        APP=$(jq -c --arg t "$APP_TYPE" --arg id "$APP_ID" \
          '.apps[$t][$id] // null' "$CFG")

        if [[ "$APP" == "null" ]]; then
          echo "‚ùå Module not found in config.json"
          exit 1
        fi

        safe() {
          echo "$APP" | jq -r --arg k "$1" 'if has($k) then .[$k] else "" end'
        }

        DIR=$(safe "directory")
        BUILD_CMD=$(safe "build-command")
        DEPLOY=$(safe "deploy")

        echo "directory=$DIR"   >> $GITHUB_OUTPUT
        echo "build=$BUILD_CMD" >> $GITHUB_OUTPUT
        echo "deploy=$DEPLOY"   >> $GITHUB_OUTPUT

    ##################################################################
    #             READ AWS HOSTING CONFIG (FROM SSM)                 #
    ##################################################################
    - name: Fetch hosting config from SSM
      id: aws
      shell: bash
      run: |
        APP_ID="${{ inputs.app-id }}"
        APP_TYPE="${{ inputs.app-type }}"

        # SSM parameter paths
        BUCKET_PARAM="/${APP_TYPE}/${APP_ID}/bucket"
        REGION_PARAM="/${APP_TYPE}/${APP_ID}/region"

        BUCKET=$(aws ssm get-parameter --name "$BUCKET_PARAM" --query "Parameter.Value" --output text 2>/dev/null || true)
        REGION=$(aws ssm get-parameter --name "$REGION_PARAM" --query "Parameter.Value" --output text 2>/dev/null || true)

        if [[ -z "$BUCKET" || -z "$REGION" ]]; then
          echo "‚ùå Missing SSM params:"
          echo "   $BUCKET_PARAM ‚Üí '$BUCKET'"
          echo "   $REGION_PARAM ‚Üí '$REGION'"
          exit 1
        fi

        echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
        echo "region=$REGION" >> $GITHUB_OUTPUT

    ##################################################################
    #                         BUILD FRONTEND                         #
    ##################################################################
    - name: Build frontend
      if: ${{ steps.cfg.outputs.deploy == 'true' }}
      shell: bash
      working-directory: ${{ steps.cfg.outputs.directory }}
      run: |
        echo "üèóÔ∏è Building frontend..."
        ${{ steps.cfg.outputs.build }}

    ##################################################################
    #                        AWS CREDENTIALS                         #
    ##################################################################
    - name: Configure AWS
      if: ${{ steps.cfg.outputs.deploy == 'true' }}
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: ${{ steps.aws.outputs.region }}

    ##################################################################
    #                           DEPLOY                                #
    ##################################################################
    - name: Deploy to S3
      if: ${{ steps.cfg.outputs.deploy == 'true' }}
      shell: bash
      run: |
        aws s3 sync \
          ${{ steps.cfg.outputs.directory }}/build \
          s3://${{ steps.aws.outputs.bucket }} \
          --delete

        echo "‚ú® Deployment completed to S3 bucket: ${{ steps.aws.outputs.bucket }}"
