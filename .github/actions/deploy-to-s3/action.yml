name: "Deploy Module to AWS S3"
description: "Deploys a frontend module from config.json safely"

inputs:
  app-type:
    required: true
  app-id:
    required: true
  config-path:
    required: true
    default: ./config.json

  aws-access-key-id:
    required: true
  aws-secret-access-key:
    required: true

runs:
  using: composite
  steps:
    - name: Read config
      id: cfg
      shell: bash
      run: |
        CONFIG_PATH="${{ inputs.config-path }}"
        APP_ID="${{ inputs.app-id }}"
        APP_TYPE="${{ inputs.app-type }}"

        APP=$(jq -c --arg t "$APP_TYPE" --arg id "$APP_ID" \
          '.apps[$t][$id] // null' "$CONFIG_PATH")

        if [[ "$APP" == "null" ]]; then
          echo "âŒ Module not found."
          exit 1
        fi

        safe_get() {
          echo "$APP" | jq -r --arg k "$1" \
            'if has($k) and .[$k] != null then .[$k] else "" end'
        }

        DIR=$(safe_get "directory")
        BUILD_CMD=$(safe_get "build-command")
        DEPLOY=$(safe_get "deploy")
        BUCKET=$(safe_get "s3-bucket")
        REGION=$(safe_get "s3-region")

        echo "directory=$DIR" >> $GITHUB_OUTPUT
        echo "build_command=$BUILD_CMD" >> $GITHUB_OUTPUT
        echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT
        echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
        echo "region=$REGION" >> $GITHUB_OUTPUT

    - name: Skip deploy
      if: ${{ steps.cfg.outputs.deploy != 'true' }}
      shell: bash
      run: echo "ðŸš« Deploy disabled."

    - name: Build frontend
      if: ${{ steps.cfg.outputs.deploy == 'true' }}
      shell: bash
      working-directory: ${{ steps.cfg.outputs.directory }}
      run: ${{ steps.cfg.outputs.build_command }}

    - name: Configure AWS
      if: ${{ steps.cfg.outputs.deploy == 'true' }}
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: ${{ steps.cfg.outputs.region }}

    - name: Upload to S3
      if: ${{ steps.cfg.outputs.deploy == 'true' }}
      shell: bash
      run: |
        aws s3 sync \
          ${{ steps.cfg.outputs.directory }}/build \
          s3://${{ steps.cfg.outputs.bucket }} \
          --delete
